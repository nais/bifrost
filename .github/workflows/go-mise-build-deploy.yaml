# Reusable workflow for Go projects using mise
# This workflow expects the following tasks to be defined in mise.toml:
#   - version: Generate version string (e.g., YYYYMMDD-gitsha)
#   - Individual tasks: tidy-check, fmt-check, lint, vet, check, test-race, build
#
# Projects can customize behavior through mise.toml without modifying this workflow
name: Go Build and Deploy with mise

on:
  workflow_call:
    inputs:
      mise-task-version:
        description: 'mise task name for version generation'
        required: false
        type: string
        default: 'version'
      mise-tasks:
        description: 'JSON array of mise tasks to run in parallel (e.g., ["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"])'
        required: false
        type: string
        default: '["tidy-check", "fmt-check", "lint", "vet", "check", "test-race"]'
      mise-task-build:
        description: 'mise task name for building'
        required: false
        type: string
        default: 'build'
      builds-docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: true
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      docker-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      builds-chart:
        description: 'Build and push Helm chart'
        required: false
        type: boolean
        default: false
      chart-path:
        description: 'Path to Helm chart directory'
        required: false
        type: string
        default: './charts'
      deploys-to-fasit:
        description: 'Deploy to Fasit'
        required: false
        type: boolean
        default: false
      creates-git-tag:
        description: 'Create git tag on main branch'
        required: false
        type: boolean
        default: true
      artifact-registry:
        description: 'Artifact registry URL'
        required: false
        type: string
        default: 'europe-north1-docker.pkg.dev'
      artifact-repo:
        description: 'Artifact repository path'
        required: false
        type: string
        default: 'nais-io/nais/images'
      chart-repo:
        description: 'Helm chart repository path'
        required: false
        type: string
        default: 'nais-io/nais/feature'
      runner-size:
        description: 'GitHub runner size for most jobs'
        required: false
        type: string
        default: 'ubuntu-latest'
      runner-size-docker:
        description: 'GitHub runner size for Docker build'
        required: false
        type: string
        default: 'ubuntu-latest-16-cores'
      helm-version:
        description: 'Helm version to use'
        required: false
        type: string
        default: 'v3.19.3'
    secrets:
      NAIS_IO_WORKLOAD_IDENTITY_PROVIDER:
        required: false
    outputs:
      version:
        description: "Generated version"
        value: ${{ jobs.meta.outputs.version }}
      image:
        description: "Docker image URL"
        value: ${{ jobs.meta.outputs.image }}

permissions:
  contents: read

jobs:
  meta:
    name: Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.name.outputs.name }}
      image-base: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}
      image: ${{ inputs.artifact-registry }}/${{ inputs.artifact-repo }}/${{ steps.name.outputs.name }}:${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2

      - id: version
        run: echo "version=$(mise run ${{ inputs.mise-task-version }})" >> ${GITHUB_OUTPUT}

      - id: name
        run: echo "name=${{ github.event.repository.name }}" >> ${GITHUB_OUTPUT}

  lint:
    name: Check
    strategy:
      fail-fast: false
      matrix:
        task: ${{ fromJson(inputs.mise-tasks) }}
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2

      - name: Run ${{ matrix.task }}
        run: mise run ${{ matrix.task }}

  build:
    name: Build
    runs-on: ${{ inputs.runner-size }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # ratchet:actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # ratchet:jdx/mise-action@v2

      - run: mise run ${{ inputs.mise-task-build }}

  docker:
    name: Build Docker Image
    if: ${{ inputs.builds-docker }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size-docker }}
    needs: [meta, lint, build]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token

      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # ratchet:docker/setup-buildx-action@v3

      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # ratchet:docker/login-action@v3
        if: steps.auth.conclusion == 'success'
        with:
          registry: ${{ inputs.artifact-registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - id: metadata
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # ratchet:docker/metadata-action@v5
        with:
          images: ${{ needs.meta.outputs.image-base }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=sha
            type=raw,value=${{ needs.meta.outputs.version }}

      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # ratchet:docker/build-push-action@v6
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile-path }}
          push: ${{ github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success' }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  chart:
    name: Build Helm Chart
    if: ${{ inputs.builds-chart }}
    permissions:
      contents: read
      id-token: write
    runs-on: ${{ inputs.runner-size }}
    needs: meta
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - name: Update Chart metadata
        run: |
          CHART_DIR="${{ inputs.chart-path }}/${{ needs.meta.outputs.name }}"
          if [ -f "${CHART_DIR}/Chart.yaml" ]; then
            sed -i "s/^version:.*$/version: ${{ needs.meta.outputs.version }}/g" "${CHART_DIR}/Chart.yaml"
            sed -i "s/^appVersion:.*$/appVersion: ${{ needs.meta.outputs.version }}/g" "${CHART_DIR}/Chart.yaml"
          fi
          if [ -f "${CHART_DIR}/values.yaml" ]; then
            sed -i "s/^    tag:.*$/    tag: ${{ needs.meta.outputs.version }}/g" "${CHART_DIR}/values.yaml"
          fi

      - id: auth
        if: github.actor != 'dependabot[bot]'
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-${{ github.event.repository.name }}@nais-io.iam.gserviceaccount.com
          token_format: access_token

      - uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # ratchet:google-github-actions/setup-gcloud@v2
        if: steps.auth.conclusion == 'success'

      - if: steps.auth.conclusion == 'success'
        run: echo '${{ steps.auth.outputs.access_token }}' | docker login -u oauth2accesstoken --password-stdin https://${{ inputs.artifact-registry }}

      - uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # ratchet:azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - run: helm package "${{ inputs.chart-path }}/${{ needs.meta.outputs.name }}" -d "${{ inputs.chart-path }}"

      - if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.auth.conclusion == 'success'
        run: helm push "${{ inputs.chart-path }}"/*.tgz oci://${{ inputs.artifact-registry }}/${{ inputs.chart-repo }}

  rollout:
    name: Deploy to Fasit
    if: ${{ inputs.deploys-to-fasit && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: fasit-deploy
    permissions:
      id-token: write
    needs: [meta, docker, chart]
    steps:
      - uses: nais/fasit-deploy@8727ed1c7a5a465e837873e6016a9a692a6b874a # ratchet:nais/fasit-deploy@v2
        with:
          chart: oci://${{ inputs.artifact-registry }}/${{ inputs.chart-repo }}/${{ needs.meta.outputs.name }}
          version: ${{ needs.meta.outputs.version }}

  tag:
    name: Create Git Tag
    if: ${{ inputs.creates-git-tag && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: meta
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
      - run: |
          git tag ${{ needs.meta.outputs.version }}
          git push origin ${{ needs.meta.outputs.version }}
